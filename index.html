<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planificador Académico — Versión con Fallback (HTML/JS)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1320; --card:#101a2d; --muted:#8aa0c3; --text:#e7eefc; --accent:#3b82f6;
      --accent-2:#22c55e; --warn:#f59e0b; --error:#ef4444; --ok:#10b981;
      --chip:#1b2946; --border:#263145;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1320;color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:rgba(11,19,32,.9);backdrop-filter:saturate(140%) blur(6px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px 20px}
    h1{margin:0;font-size:22px} small.muted{color:var(--muted)}
    .grid{display:grid;gap:16px;grid-template-columns:320px 1fr;align-items:start}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:#15223a;color:var(--text);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:transparent;color:white}
    .btn.success{background:var(--accent-2);border-color:transparent;color:#062412}
    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted)}
    label{font-size:13px;color:var(--muted)} input[type="file"]{width:100%}
    select,input[type="text"]{width:100%;background:#0f1a30;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px 10px}
    .status{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .status .item{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:10px;background:#0f1a30}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.err{background:var(--error)}
    .tabs{display:flex;gap:6px;margin-bottom:8px} .tabs button{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:#0f1a30;color:var(--text);cursor:pointer}
    .tabs button.active{background:var(--accent);color:#fff;border-color:transparent}
    .vis{display:none} .vis.active{display:block}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{border-bottom:1px solid var(--border);padding:8px 6px;text-align:left;font-size:12.5px}
    .grid-week{display:grid;grid-template-columns:110px repeat(5,1fr);gap:10px}
    .col{display:flex;flex-direction:column;gap:10px}
    .cell{border:1px solid var(--border);border-radius:8px;padding:6px;background:#0e1a2f}
    .help{font-size:12.5px;color:var(--muted)}
    .sr-only{position:absolute;left:-9999px;width:1px;height:1px;overflow:hidden}
  </style>
  <!-- SheetJS (CDN). Si su red bloquea CDNs, el sistema activará un "fallback" sin XLSX (acepta CSV y dataset de ejemplo). -->
  <script id="sheetjs-cdn" src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between;align-items:center">
        <div>
          <h1>Planificador Académico (con Fallback)</h1>
          <small class="muted">Si el cargador de Excel no inicializa, cargue CSV o use el dataset de ejemplo.</small>
        </div>
        <div class="row">
          <button id="btnSave" class="btn">Guardar</button>
          <button id="btnLoad" class="btn">Recuperar</button>
          <button id="btnExportCareer" class="btn">CSV Carreras/Ciclos</button>
          <button id="btnExportStudent" class="btn">CSV Estudiantes</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="grid">
      <section class="card" aria-labelledby="secCarga">
        <h2 id="secCarga">1) Carga de archivos</h2>
        <div class="row">
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" multiple />
        </div>
        <div id="envStatus" class="status"></div>
        <div id="loadStatus" class="status"></div>
        <div class="row" style="margin-top:8px">
          <span class="pill"><span class="dot ok"></span> Requiere XLSX para Excel</span>
          <span class="pill"><span class="dot warn"></span> Fallback CSV activo si XLSX no carga</span>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnPlanificar" class="btn primary">Planificar</button>
        </div>
      </section>
      <section class="card">
        <div class="tabs" role="tablist">
          <button class="active" id="tabCareer">Carrera/Ciclo</button>
          <button id="tabStudent">Estudiante</button>
          <button id="tabConflicts">Conflictos</button>
          <button id="tabHelp">Ayuda</button>
        </div>
        <section id="viewCareer" class="vis active"></section>
        <section id="viewStudent" class="vis">
          <div class="row">
            <select id="selEstudiante" size="8" style="min-width:260px"></select>
            <div>
              <button id="btnMoverAsignatura" class="btn">Mover</button>
              <button id="btnReemplazarAsignatura" class="btn">Reemplazar paralelo</button>
              <div id="studentSchedule" style="margin-top:10px"></div>
            </div>
          </div>
        </section>
        <section id="viewConflicts" class="vis">
          <table><thead><tr><th>Tipo</th><th>Descripción</th></tr></thead><tbody id="confBody"></tbody></table>
        </section>
        <section id="viewHelp" class="vis">
          <p class="help">
            Si el estado indica <b>“XLSX no cargado”</b>, su navegador/red bloquea el CDN.
            En ese caso: 1) conéctese a internet sin bloqueo; o 2) cargue archivos <b>CSV</b> con los mismos encabezados;
            o 3) use el dataset de ejemplo (se precarga).
          </p>
        </section>
        <div id="alerts" class="sr-only" aria-live="assertive"></div>
      </section>
    </div>
  </main>

  <script>
  (function(){
    "use strict";

    // ===== Diagnóstico de entorno
    const env = document.getElementById("envStatus");
    function pill(ok, text){
      const c = ok ? "ok" : "err";
      return `<div class="item"><span class="dot ${c}"></span><span>${text}</span></div>`;
    }
    function cspNormalize(s){return (s||"").normalize("NFD").replace(/[\\u0300-\\u036f]/g,"");}

    setTimeout(()=>{
      const hasXLSX = !!window.XLSX;
      env.innerHTML =
        pill(hasXLSX, hasXLSX ? "XLSX cargado (Excel habilitado)" : "XLSX no cargado (CDN bloqueado o sin internet)") +
        pill(true, "Fallback CSV listo");
      if(!hasXLSX){
        console.warn("SheetJS no disponible. Se permite carga de CSV y dataset de ejemplo.");
      }
    }, 400);

    // ===== Estado mínimo + dataset de ejemplo
    const state = {
      datasets: { malla:[], oferta:[], estudiantes:[], ingles:[], practicas:[] },
      placements: [], studentAssign: [], conflictos: []
    };
    const SAMPLE = {
      malla:[
        {carrera:"Administracion", ciclo:"1", codigo_asignatura:"ADM101", nombre_asignatura:"Fundamentos de Administración", compartida_entre_carreras:"no"},
        {carrera:"Administracion", ciclo:"1", codigo_asignatura:"MAT101", nombre_asignatura:"Matemática I", compartida_entre_carreras:"si"},
        {carrera:"Negocios", ciclo:"1", codigo_asignatura:"NEG101", nombre_asignatura:"Introducción a los Negocios", compartida_entre_carreras:"no"},
        {carrera:"Negocios", ciclo:"1", codigo_asignatura:"MAT101", nombre_asignatura:"Matemática I", compartida_entre_carreras:"si"}
      ],
      oferta:[
        {codigo_asignatura:"ADM101", paralelo:"A", docente:"Dr. Pérez", capacidad_maxima:40, carrera:"Administracion"},
        {codigo_asignatura:"MAT101", paralelo:"A", docente:"Ing. Ruiz", capacidad_maxima:50, carrera:"Administracion"},
        {codigo_asignatura:"NEG101", paralelo:"A", docente:"MSc. León", capacidad_maxima:30, carrera:"Negocios"},
        {codigo_asignatura:"MAT101", paralelo:"B", docente:"Ing. Ruiz", capacidad_maxima:45, carrera:"Negocios"}
      ],
      estudiantes:[
        {id_estudiante:"E01", nombre_estudiante:"Ana Gómez", carrera:"Administracion", ciclo_actual:"1", nivel_ingles:"B1", en_practicas:"no"},
        {id_estudiante:"E02", nombre_estudiante:"Luis Paredes", carrera:"Administracion", ciclo_actual:"1", nivel_ingles:"A2", en_practicas:"no"},
        {id_estudiante:"E03", nombre_estudiante:"Carla Ríos", carrera:"Negocios", ciclo_actual:"1", nivel_ingles:"B2", en_practicas:"no"}
      ]
    };
    state.datasets = JSON.parse(JSON.stringify(SAMPLE));

    // ===== Utilidades breves (mismas reglas y franjas)
    const DIAS = ["Lun","Mar","Mié","Jue","Vie"];
    const FRANJAS = ["7-10","10-13","13-16","16-19","19-22"];
    const MAX_POR_DIA = 2;
    const MAX_POR_ESTUDIANTE = 6;
    const loadStatus = document.getElementById("loadStatus");
    const alerts = document.getElementById("alerts");

    function alertLive(msg){ alerts.textContent = msg; }
    function addStatus(label, ok=true){ loadStatus.insertAdjacentHTML("beforeend", `<div class="item"><span class="dot ${ok?"ok":"err"}"></span>${label}</div>`); }
    function unique(arr){ return [...new Set(arr)]; }
    function escapeHtml(s){ return String(s||"").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[m])); }

    // ===== Carga de archivos con fallback CSV
    const fileInput = document.getElementById("fileInput");
    fileInput.addEventListener("change", async (e)=>{
      loadStatus.innerHTML = "";
      const files = Array.from(e.target.files||[]);
      if(!files.length){ addStatus("Sin archivos", false); return; }
      for(const f of files){
        const name = f.name.toLowerCase();
        try{
          if((window.XLSX) && (name.endsWith(".xlsx") || name.endsWith(".xls"))){
            const data = await f.arrayBuffer();
            const wb = XLSX.read(data, {type:"array"});
            const ws = wb.Sheets[wb.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(ws,{defval:""});
            routeDatasetGuess(f.name, json);
          }else if(name.endsWith(".csv")){
            const text = await f.text();
            const json = csvToJson(text);
            routeDatasetGuess(f.name, json);
          }else{
            addStatus(`${f.name}: formato no soportado sin XLSX`, false);
          }
        }catch(err){
          console.error(err); addStatus(`${f.name}: error al procesar`, false);
        }
      }
      addStatus("Archivos procesados");
    });

    function csvToJson(text){
      // Parser CSV sencillo (coma; admite comillas)
      const lines = text.replace(/\\r/g,"").split("\\n").filter(Boolean);
      if(!lines.length) return [];
      const headers = splitCSVLine(lines[0]);
      const rows = [];
      for(let i=1;i<lines.length;i++){
        const vals = splitCSVLine(lines[i]);
        const obj = {};
        headers.forEach((h,idx)=> obj[h] = vals[idx] ?? "");
        rows.push(obj);
      }
      return rows;
    }
    function splitCSVLine(line){
      const out=[], re=/(?:^|,)(\"(?:(?:\"\")*[^\"]*)*\"|[^,]*)/g; let m;
      while((m=re.exec(line))!==null){
        let v=m[1]; if(v && v[0]===",") v=v.slice(1);
        if(v && v[0]==='"') v=v.slice(1,-1).replace(/""/g,'"');
        out.push(v||"");
      }
      return out;
    }

    // Heurística mínima para detectar tipo (malla/oferta/estudiantes) por headers
    function routeDatasetGuess(fname, rows){
      const headers = Object.keys(rows[0]||{}).map(h=>h.toLowerCase());
      const score = {
        malla: ["carrera","ciclo","codigo","codigo_asignatura","nombre","nombre_asignatura"].filter(k=>headers.some(h=>h.includes(k))).length,
        oferta: ["codigo","paralelo","docente"].filter(k=>headers.some(h=>h.includes(k))).length,
        estudiantes: ["id","estudiante","carrera","ciclo","nivel"].filter(k=>headers.some(h=>h.includes(k))).length
      };
      const tipo = Object.entries(score).sort((a,b)=>b[1]-a[1])[0][0];
      state.datasets[tipo].push(...rows);
      addStatus(`${fname}: cargado como ${tipo}`);
    }

    // ===== Planificación simplificada (mismo enfoque)
    document.getElementById("btnPlanificar").addEventListener("click", ()=>{
      try{
        planificar(); renderCareer(); renderStudent(); renderConflicts();
        alertLive("Planificación completada.");
      }catch(e){ console.error(e); alertLive("Error en planificación."); }
    });

    function planificar(){
      state.placements = []; state.studentAssign = []; state.conflictos = [];
      // Tomar primeras carreras/ciclos detectados del dataset (para este fallback)
      const carreras = unique(state.datasets.malla.map(x=>String(x.carrera||"").trim()).filter(Boolean));
      const ciclos = unique(state.datasets.malla.map(x=>String(x.ciclo||"").trim()).filter(Boolean)).sort((a,b)=>Number(a)-Number(b));
      const carrSel = carreras; const cicSel = ciclos;

      const malla = state.datasets.malla.filter(m => carrSel.includes(String(m.carrera)) && cicSel.includes(String(m.ciclo)));
      const oferta = state.datasets.oferta.filter(o => malla.some(m=>m.codigo_asignatura===o.codigo_asignatura || m.codigo_asignatura===o.codigo || (m.codigo && m.codigo===o.codigo)));
      const estudiantes = state.datasets.estudiantes.filter(e => carrSel.includes(String(e.carrera)) && cicSel.includes(String(e.ciclo_actual||e.ciclo||"")));
      const ofertaByCodigo = {};
      for(const o of oferta){
        const code = o.codigo_asignatura || o.codigo;
        (ofertaByCodigo[code] ||= []).push(o);
      }

      // Variables a ubicar
      const variables = [];
      const byCarrCiclo = {};
      for(const m of malla){
        const k = `${m.carrera}||${m.ciclo}`; (byCarrCiclo[k] ||= []).push(m);
      }
      for(const k of Object.keys(byCarrCiclo)){
        const [car,cic] = k.split("||");
        const cods = unique(byCarrCiclo[k].map(x=>x.codigo_asignatura||x.codigo));
        for(const code of cods){
          const offs = ofertaByCodigo[code]||[];
          if(!offs.length){ state.conflictos.push({tipo:"Falta oferta", desc:`Sin oferta para ${code}`}); continue; }
          variables.push({carrera:car, ciclo:cic, codigo:code, paralelos:offs});
        }
      }

      // Ocupación de docente y ciclo adyacente
      const occDocDia={}, occDocSlot={}, occCarrCiclo={}, occCarrCicloSlot={};
      function canPlace(v, d, f, p){
        const keyCC = `${v.carrera}||${v.ciclo}`; const keySlot = `${d}||${f}`;
        if((occCarrCiclo[keyCC]||{})[keySlot]) return false;
        const c = Number(v.ciclo); const adj1 = `${v.carrera}||${c-1}||${d}||${f}`; const adj2 = `${v.carrera}||${c+1}||${d}||${f}`;
        if(occCarrCicloSlot[adj1] || occCarrCicloSlot[adj2]) return false;
        const doc = (p.docente||"").trim();
        if(doc){
          if(occDocSlot[`${doc}||${d}||${f}`]) return false;
          if((occDocDia[`${doc}||${d}`]||0) >= MAX_POR_DIA) return false;
        }
        return true;
      }
      function place(v,d,f,p){
        const keyCC = `${v.carrera}||${v.ciclo}`; const keySlot = `${d}||${f}`;
        (occCarrCiclo[keyCC] ||= {}); occCarrCiclo[keyCC][keySlot] = v.codigo;
        occCarrCicloSlot[`${v.carrera}||${v.ciclo}||${d}||${f}`] = true;
        const doc = (p.docente||"").trim();
        if(doc){ occDocSlot[`${doc}||${d}||${f}`] = true; occDocDia[`${doc}||${d}`] = (occDocDia[`${doc}||${d}`]||0)+1; }
        state.placements.push({carrera:v.carrera,ciclo:v.ciclo,codigo:v.codigo,paralelo:p.paralelo,docente:p.docente||"",dia:d,franja:f});
      }
      function unplace(v,d,f,p){
        const keyCC = `${v.carrera}||${v.ciclo}`; const keySlot = `${d}||${f}`;
        if(occCarrCiclo[keyCC]) delete occCarrCiclo[keyCC][keySlot];
        delete occCarrCicloSlot[`${v.carrera}||${v.ciclo}||${d}||${f}`];
        const doc = (p.docente||"").trim();
        if(doc){
          delete occDocSlot[`${doc}||${d}||${f}`];
          const cnt=(occDocDia[`${doc}||${d}`]||1)-1; if(cnt<=0) delete occDocDia[`${doc}||${d}`]; else occDocDia[`${doc}||${d}`]=cnt;
        }
        const i = state.placements.findIndex(x=>x.carrera===v.carrera && x.ciclo===v.ciclo && x.codigo===v.codigo && x.paralelo===p.paralelo && x.dia===d && x.franja===f);
        if(i>=0) state.placements.splice(i,1);
      }
      function backtrack(i){
        if(i>=variables.length) return true;
        const v=variables[i]; const cands=[];
        for(const d of DIAS){ for(const f of FRANJAS){ for(const p of v.paralelos){ if(canPlace(v,d,f,p)) cands.push({d,f,p}); }}}
        for(const c of cands){ place(v,c.d,c.f,c.p); if(backtrack(i+1)) return true; unplace(v,c.d,c.f,c.p); }
        state.conflictos.push({tipo:"Sin ubicación", desc:`No se pudo ubicar ${v.codigo} (${v.carrera}/${v.ciclo})`});
        return false;
      }
      backtrack(0);

      // Asignación estudiante
      const placementsIndex = {}; for(const p of state.placements){ (placementsIndex[p.codigo] ||= []).push(p); }
      for(const e of estudiantes){
        const car = e.carrera; const cic = String(e.ciclo_actual||e.ciclo||"");
        const materias = unique(malla.filter(m=>String(m.carrera)===car && String(m.ciclo)===cic).map(x=>x.codigo_asignatura||x.codigo));
        const dayCount={}; const asignadas=[];
        function canAssign(pl){
          if((dayCount[pl.dia]||0) >= MAX_POR_DIA) return false;
          if(asignadas.length >= MAX_POR_ESTUDIANTE) return false;
          if(asignadas.some(a=>a.dia===pl.dia && a.franja===pl.franja)) return false;
          return true;
        }
        for(const cod of materias){
          const pls = (placementsIndex[cod]||[]);
          for(const pl of pls){ if(canAssign(pl)){ asignadas.push({codigo:cod,paralelo:pl.paralelo,dia:pl.dia,franja:pl.franja,docente:pl.docente,carrera:car,ciclo:cic});
            dayCount[pl.dia]=(dayCount[pl.dia]||0)+1;
            state.studentAssign.push({id_estudiante:e.id_estudiante||e.id, nombre_estudiante:e.nombre_estudiante||e.estudiante||"", codigo:cod, paralelo:pl.paralelo, dia:pl.dia, franja:pl.franja, docente:pl.docente, carrera:car, ciclo:cic});
            break; }
          }
        }
      }
    }

    // ===== Renderizaciones mínimas
    function renderCareer(){
      const cont = document.getElementById("viewCareer"); cont.innerHTML="";
      const byKey={}; for(const p of state.placements){ const k=`${p.carrera}||${p.ciclo}`; (byKey[k] ||= []).push(p); }
      const keys = Object.keys(byKey).sort();
      if(!keys.length){ cont.innerHTML = `<p class="help">Sin ubicaciones.</p>`; return; }
      for(const k of keys){
        const [car,cic]=k.split("||");
        cont.insertAdjacentHTML("beforeend", `<h3>${escapeHtml(car)} / Ciclo ${escapeHtml(cic)}</h3>`);
        const grid = document.createElement("div"); grid.className="grid-week";
        const colHdr = document.createElement("div"); colHdr.className="col";
        colHdr.appendChild(cellHeader("Franja/Día")); FRANJAS.forEach(f=>colHdr.appendChild(cellHeader(f)));
        grid.appendChild(colHdr);
        for(const d of DIAS){
          const col=document.createElement("div"); col.className="col";
          col.appendChild(cellHeader(d));
          for(const f of FRANJAS){
            const cell=document.createElement("div"); cell.className="cell";
            const items=byKey[k].filter(p=>p.dia===d && p.franja===f);
            cell.innerHTML = items.length ? items.map(it=>`<div><b>${escapeHtml(it.codigo)}</b> — Par ${escapeHtml(it.paralelo)}<br><span class="help">${escapeHtml(it.docente||"")}</span></div>`).join("") : `<span class="help">—</span>`;
            col.appendChild(cell);
          }
          grid.appendChild(col);
        }
        cont.appendChild(grid);
      }
      function cellHeader(t){ const div=document.createElement("div"); div.className="cell"; div.style.background="#0b1a33"; div.style.fontWeight="600"; div.textContent=t; return div; }
    }

    function renderStudent(){
      populateStudentSelect();
      const id = document.getElementById("selEstudiante").value;
      const target = document.getElementById("studentSchedule"); target.innerHTML="";
      if(!id) return;
      const rows = state.studentAssign.filter(a=> (a.id_estudiante||a.id)===id);
      const grid=document.createElement("div"); grid.className="grid-week";
      const colHdr=document.createElement("div"); colHdr.className="col";
      colHdr.appendChild(cellHeader("Franja/Día")); FRANJAS.forEach(f=>colHdr.appendChild(cellHeader(f)));
      grid.appendChild(colHdr);
      for(const d of DIAS){
        const col=document.createElement("div"); col.className="col";
        col.appendChild(cellHeader(d));
        for(const f of FRANJAS){
          const cell=document.createElement("div"); cell.className="cell";
          const items=rows.filter(p=>p.dia===d && p.franja===f);
          cell.innerHTML = items.length ? items.map(it=>`<div><b>${escapeHtml(it.codigo)}</b> — Par ${escapeHtml(it.paralelo)}<br><span class="help">${escapeHtml(it.docente||"")}</span></div>`).join("") : `<span class="help">—</span>`;
          col.appendChild(cell);
        }
        grid.appendChild(col);
      }
      target.appendChild(grid);
      function cellHeader(t){ const div=document.createElement("div"); div.className="cell"; div.style.background="#0b1a33"; div.style.fontWeight="600"; div.textContent=t; return div; }
    }
    function populateStudentSelect(){
      const ests = unique(state.studentAssign.map(a=>a.id_estudiante||a.id))
        .map(id=>{
          const any=state.studentAssign.find(x=>(x.id_estudiante||x.id)===id);
          return {id, nombre: any?.nombre_estudiante || id};
        }).sort((a,b)=>a.nombre.localeCompare(b.nombre));
      const sel=document.getElementById("selEstudiante");
      sel.innerHTML=ests.map(e=>`<option value="${e.id}">${escapeHtml(e.nombre)} (${escapeHtml(e.id)})</option>`).join("");
      sel.onchange = renderStudent;
      if(ests.length && !sel.value){ sel.value=ests[0].id; }
    }
    function renderConflicts(){
      const body=document.getElementById("confBody"); body.innerHTML="";
      for(const c of state.conflictos){
        body.insertAdjacentHTML("beforeend", `<tr><td>${escapeHtml(c.tipo)}</td><td>${escapeHtml(c.desc)}</td></tr>`);
      }
    }

    // Edición básica (con validaciones mínimas)
    document.getElementById("btnMoverAsignatura").onclick = ()=>{
      const id = document.getElementById("selEstudiante").value; if(!id) return;
      const cod = prompt("Código a mover:"); if(!cod) return;
      const dia = prompt("Nuevo día (Lun,Mar,Mié,Jue,Vie):"); const fr = prompt("Nueva franja (7-10,10-13,13-16,16-19,19-22):");
      if(!DIAS.includes(dia) || !FRANJAS.includes(fr)){ alertLive("Día/franja inválidos"); return; }
      const a = state.studentAssign.find(x=>(x.id_estudiante||x.id)===id && (x.codigo===cod));
      if(!a){ alertLive("No encontrado."); return; }
      const dayCount = state.studentAssign.filter(x=>(x.id_estudiante||x.id)===id && x.dia===dia && !(x.codigo===cod)).length;
      if(dayCount>=MAX_POR_DIA){ alertLive("Límite diario (2) superado."); return; }
      const choque = state.studentAssign.some(x=>(x.id_estudiante||x.id)===id && x.dia===dia && x.franja===fr && !(x.codigo===cod));
      if(choque){ alertLive("Cruce horario."); return; }
      a.dia=dia; a.franja=fr; renderStudent(); alertLive("Movimiento aplicado.");
    };
    document.getElementById("btnReemplazarAsignatura").onclick = ()=>{
      const id = document.getElementById("selEstudiante").value; if(!id) return;
      const cod = prompt("Código a reemplazar:"); if(!cod) return;
      const par = prompt("Nuevo paralelo:"); if(!par) return;
      const a = state.studentAssign.find(x=>(x.id_estudiante||x.id)===id && x.codigo===cod);
      const pl = state.placements.find(p=>p.codigo===cod && p.paralelo===par);
      if(!a || !pl){ alertLive("Paralelo no disponible."); return; }
      const choque = state.studentAssign.some(x=>(x.id_estudiante||x.id)===id && x.dia===pl.dia && x.franja===pl.franja && !(x.codigo===cod));
      if(choque){ alertLive("Cruce horario."); return; }
      a.paralelo=par; a.dia=pl.dia; a.franja=pl.franja; a.docente=pl.docente; renderStudent(); alertLive("Reemplazo aplicado.");
    };

    // ===== Guardar / Cargar / Exportar
    document.getElementById("btnSave").onclick = ()=>{
      localStorage.setItem("planificador_fallback_v1", JSON.stringify(state));
      alertLive("Guardado en este navegador.");
    };
    document.getElementById("btnLoad").onclick = ()=>{
      const raw = localStorage.getItem("planificador_fallback_v1");
      if(!raw){ alertLive("No hay datos guardados."); return; }
      try{ const s=JSON.parse(raw); Object.assign(state, s); renderCareer(); renderStudent(); renderConflicts(); alertLive("Recuperado."); }catch{ alertLive("Error al recuperar."); }
    };
    document.getElementById("btnExportCareer").onclick = ()=>{
      const rows = state.placements.map(p=>({carrera:p.carrera,ciclo:p.ciclo,dia:p.dia,franja:p.franja,codigo:p.codigo,paralelo:p.paralelo,docente:p.docente}));
      download("horario_carreras_ciclos.csv", toCSV(rows));
    };
    document.getElementById("btnExportStudent").onclick = ()=>{
      const rows = state.studentAssign.map(a=>({id_estudiante:a.id_estudiante||a.id,nombre_estudiante:a.nombre_estudiante||"",carrera:a.carrera,ciclo:a.ciclo,codigo:a.codigo,paralelo:a.paralelo,dia:a.dia,franja:a.franja,docente:a.docente}));
      download("horario_estudiantes.csv", toCSV(rows));
    };
    function toCSV(rows){
      if(!rows.length) return "";
      const cols = Object.keys(rows[0]); const esc=s=>/[\",\\n]/.test(String(s)) ? '"'+String(s).replace(/\"/g,'""')+'"' : String(s);
      return [cols.join(",")].concat(rows.map(r=>cols.map(c=>esc(r[c]??"")).join(","))).join("\\n");
    }
    function download(filename, text){
      const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href=url; a.download=filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    }

    // ===== Tabs
    const tabs = {tabCareer:"viewCareer", tabStudent:"viewStudent", tabConflicts:"viewConflicts", tabHelp:"viewHelp"};
    Object.keys(tabs).forEach(tid=>{
      document.getElementById(tid).onclick = ()=>{
        document.querySelectorAll(".tabs button").forEach(b=>b.classList.toggle("active", b.id===tid));
        document.querySelectorAll(".vis").forEach(v=>v.classList.remove("active"));
        document.getElementById(tabs[tid]).classList.add("active");
      };
    });

  })();
  </script>
</body>
</html>
